### Basic settings
# improve colors
set -ga terminal-overrides ",screen-256color*:Tc"
set -g default-terminal "screen-256color"

# switch to next session on destroy
set -g detach-on-destroy off

# start window numbers at 1 to match keyboard order with tmux order
set -g base-index 1

# start pane numbers at 1 to match keyboard order with tmux order
setw -g pane-base-index 1

# increase scrollback lines
set -g history-limit 65536

# enable mouse control (clickable windows, panes, resizable panes)
set -g mouse on


### Keybindings
# set prefix to Ctrl+A
unbind C-b
set -g prefix C-a
# C-a + C-a will send C-a through: helpful for nested tmux sessions as well
bind C-a send-prefix

# reload config file with Ctrl-r
bind r source-file ~/.config/tmux/tmux.conf \; display-message "config reloaded!"

### Vim keybindings for nav + window/pane management
setw -g mode-keys vi

# vi keybindings for command, choice, paste buffer, and find prompts
set -g status-keys vi

# vi keybindings for pane selection
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# shift + vi movements for resizing panes
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# toggle synchronize-panes
bind C-y setw synchronize-panes

# vi keybindings for cycling through windows
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

# switch to windows 1 through 4
# ctrl+a c -> new window
# ctrl+a , -> rename current window
# ctrl+a w -> show list of windows and sessions
unbind p  # don't need the previous window switching
bind u select-window -t 1
bind i select-window -t 2
bind o select-window -t 3
bind p select-window -t 4

# create new windows/panes in same directory
bind c new-window -c "#{pane_current_path}"

# sensible split pane bindings: https://github.com/tmux-plugins/tmux-pain-control
# horizontal and vertical splits with `|` and `-` w/ default keybindings intact
bind "|" split-window -h -c "#{pane_current_path}"
bind "%" split-window -h -c "#{pane_current_path}"
bind "-" split-window -v -c "#{pane_current_path}"
bind '"' split-window -v -c "#{pane_current_path}"

# full window split into two (full width + full height)
bind "\\" split-window -fh -c "#{pane_current_path}"
bind "_" split-window -fv -c "#{pane_current_path}"

# vi keybindings for copy-mode
bind -T copy-mode-vi "v" send -X begin-selection
bind -T copy-mode-vi "V" send -X rectangle-toggle
bind -T copy-mode-vi "y" send -X copy-selection-and-cancel


### Appearance and color scheme (Solarized 256)
# set -g status-style bg=colour235,fg=colour136
# setw -g window-status-style fg=colour244
# setw -g window-status-current-style fg=colour166
# setw -g window-status-activity-style fg=colour61
# setw -g window-status-bell-style fg=colour61
# set -g pane-border-style fg=colour235
# set -g pane-active-border-style fg=colour240
# set -g message-style bg=colour235,fg=colour166


### Advanced settings
# renumber windows sequentially after closing any of them
set -g renumber-windows on

# size windows based on clients looking at that window
setw -g aggressive-resize on

# make vim work better with tmux
set -g focus-events on

# don't wait for escape sequences
set -sg escape-time 0

# monitor windows for activity
setw -g monitor-activity on

# display tmux messages for 1.25s
set -g display-time 1250

# display pane numbers for 2s
set -g display-panes-time 2000

# pane number appearance
set -g display-panes-active-colour colour166 #blue
set -g display-panes-colour colour33 #orange

# set window title
set -g set-titles on
set -g set-titles-string '#T'


# Activity monitoring
setw -g monitor-activity on
set -g visual-activity on

### Utility keybindings
# enable and disable keyboard input for panes
bind < select-pane -d \; display-message "input disabled"
bind > select-pane -e \; display-message "input enabled"

# keybinding to clear history
bind C-x clear-history \; display-message "history cleared"

# switch between the last 2 sessions (similar to `cd -`)
unbind Space
bind-key Space switch-client -l

# C-b ! breaks current pane into separate window
# join a pane/window from the current session into the current window
bind @ command-prompt -p "create pane from:" "join-pane -s ':%%'"

# reenable automatic renaming for the current window
bind N setw automatic-rename on \; display-message "automatic rename enabled"

# clock
setw -g clock-mode-colour colour64 #green

# Allow local customization in ~/.tmux_local.conf
if-shell "[ -f ~/.tmux_local.conf ]" 'source ~/.tmux_local.conf'

# Create/attach to a new session for fzf'd project repo: theprimeagen
bind-key f run-shell "tmux new-window ~/.dotfiles/scripts/wd_tmux_session"

# Open project todo if it exists else open general todo: theprimeagen
bind D neww -c "#{pane_current_path}" "[[ -e TODO.md ]] && nvim TODO.md || nvim ~/wd/_wip/todo.md"

# session keybindings
# ctrl+a : -> new -s [name]
# ctrl+a $ -> rename current session
# ctrl+a s -> show list of sessions
# ctrl+a ( -> switch to previous session
# ctrl+a ) -> switch to next session

# Sort session list in reverse chronological order
# -s starts with sessions collapsed (doesn't show windows)
# -Z zooms the pane
# -O specifies the initial sort field: one of ‘index’, ‘name’, or ‘time’ (activity).
# https://unix.stackexchange.com/questions/608268/how-can-i-force-tmux-to-sort-my-sessions-alphabetically
bind s choose-tree -Zs -O time

# Create new session (prompt for name)
# -A makes this behave as `attach-session` if session already exists
bind S command-prompt -p "New Session:" "new-session -A -s '%%'"

# Kill session
bind X confirm kill-session

## Plugins
# tmux-resurrect: persist tmux sessions across system restarts
# Note: no session is deleted automatically. Select a session manually by symlinking `last` to session.txt
# in `~/.local/share/tmux/resurrect`. Ref: https://github.com/tmux-plugins/tmux-resurrect/blob/master/docs/restoring_previously_saved_environment.md#restoring-previously-saved-environment
# prefix + ctrl + [s|r] for save/restore
run-shell ~/.config/tmux/plugins/tmux-resurrect/resurrect.tmux

# known issue with default-command (if it has && or ||)
# https://github.com/tmux-plugins/tmux-resurrect/blob/master/docs/restoring_pane_contents.md#known-issue
set -g @resurrect-capture-pane-contents 'on'


# tmux-continuum: automatically save tmux session, no need to manually save/restore
run-shell ~/.config/tmux/plugins/tmux-continuum/continuum.tmux


### Status bar config
# set -g pane-border-lines 'heavy'
# set -g pane-border-format '#[bg=default fg=blue bold]#{?pane_active, ● ,}#[bg=default fg=colour8]#{?pane_last, ○ ,}'
# set -g pane-border-style 'bg=default fg=colour8'
# set -g pane-active-border-style 'bg=default fg=blue bold'
# set -g status-bg colour8
# set -g status-fg colour15
# set -g status-interval 60
# set -g status-left-length 30
# set -g status-right-length 100
# set -g window-status-separator ' '
# set -g window-status-format '#[fg=colour7 bg=colour0]  #W #{?window_last_flag,○,} #{?window_linked,∩,}'
# set -g window-status-current-format '#[bg=blue fg=white bold]  #W #{?window_active,●, } '
#
set -g status-style bg=colour235,fg=colour136
setw -g window-status-style fg=colour244
setw -g window-status-current-style fg=colour166
setw -g window-status-activity-style fg=colour61
setw -g window-status-bell-style fg=colour61
set -g pane-border-style fg=colour235
set -g pane-active-border-style fg=colour240
set -g message-style bg=colour235,fg=colour166

set -g status-left-length 20
set -g status-left '#{?pane_input_off,#[fg=colour160],#[fg=colour136]}[#[fg=colour136]#S:#I.#P#{?pane_input_off,#[fg=colour160],#[fg=colour136]}] '
set -g status-right '#[fg=colour166]#([ "$(tmux show-option -g prefix)" != "prefix C-a" ] && echo "($(tmux show-option -g prefix | cut -c 8-)) ")#[fg=colour33]%d %b %Y #{?client_prefix,#[fg=colour160],#[fg=colour61]}- #[fg=colour64]%I:%M %p #{?client_prefix,#[fg=colour160],#[fg=colour61]}- #[fg=colour37]#([ -f $HOME/.name ] && cat $HOME/.name || hostname)'


# set -g status-left '#{?client_prefix,#[fg=white bg=colour2]  ●  ,#[fg=colour8 bg=colour0]  ○  }#[default] '
# set -g status-left '#{?pane_input_off,#[fg=colour160],#[fg=colour137]}[#[fg=colour136]#S:#I.#P#{?pane_input_off,#[fg=colour163],#[fg=colour136]}] '

# set -g status-right '#{?window_zoomed_flag,#[bg=blue fg=white]  Zoom  #[default] ,} #{?client_readonly,#[fg=white bg=yellow bold] ◢◤◢◤◢◤◢◤ Read Only ◢◤◢◤◢◤◢◤  #[default] ,} #[fg=colour7 bg=colour0]  #{active_window_index}  #[default] #[fg=colour7 bg=colour0]  %I:%M %p  #[default] #[fg=white bg=5 bold]  #{session_name}  '
# set -g status-right '#[fg=colour169]#([ "$(tmux show-option -g prefix)" != "prefix C-a" ] && echo "($(tmux show-option -g prefix | cut -c 8-)) ")#[fg=colour33]%d %b %Y #{?client_prefix,#[fg=colour160],#[fg=colour61]}- #[fg=colour64]%I:%M %p #{?client_prefix,#[fg=colour160],#[fg=colour61]}- #[fg=colour37]#([ -f $HOME/.name ] && cat $HOME/.name || hostname)'

# set -g status-position top

# rose-pine: status bar theme
run-shell ~/.config/tmux/plugins/rose-pine/rose-pine.tmux

set -g @rose_pine_variant 'main'  # options are 'main', 'moon' or 'dawn'
set -g @rose_pine_host 'on'       # enable hostname
# set -g @rose_pine_date_time '%Y-%m-%d'
set -g @rose_pine_user 'on'
# set -g @rose_pine_directory 'on' # Turn on the current folder component in the status bar
# set -g @rose_pine_only_windows 'on' # Leaves only the window module, for max focus and space
# set -g @rose_pine_default_window_behavior 'on' # Forces tmux default window list behaviour
# set -g @rose_pine_show_current_program 'on' # Forces tmux to show the current running program as window name
# set -g @rose_pine_show_pane_directory 'on' # Forces tmux to show the current directory as window name
set -g @rose_pine_disable_active_window_menu 'off' # Disables the menu that shows the active window on the left

set -g @rose_pine_bar_bg_disable 'on' # Disables background color, for transparent terminal emulators
# If @rose_pine_bar_bg_disable is set to 'on', uses the provided value to set the background color
# It can be any of the on tmux (named colors, 256-color set, `default` or hex colors)
# See more on http://man.openbsd.org/OpenBSD-current/man1/tmux.1#STYLES
set -g @rose_pine_bar_bg_disabled_color_option 'default'

# Example values for these can be:
# set -g @rose_pine_left_separator ' > ' # The strings to use as separators are 1-space padded
# set -g @rose_pine_right_separator ' < ' # Accepts both normal chars & nerdfont icons
set -g @rose_pine_field_separator ' | ' # Again, 1-space padding, it updates with prefix + I
set -g @rose_pine_window_separator '-' # Replaces the default `:` between the window number and name

# These are not padded
# set -g @rose_pine_session_icon '' # Changes the default icon to the left of the session name
# set -g @rose_pine_current_window_icon '' # Changes the default icon to the left of the active window name
# set -g @rose_pine_folder_icon '' # Changes the default icon to the left of the current directory folder
# set -g @rose_pine_username_icon '' # Changes the default icon to the right of the hostname
# set -g @rose_pine_hostname_icon '󰒋' # Changes the default icon to the right of the hostname
# set -g @rose_pine_date_time_icon '󰃰' # Changes the default icon to the right of the date module
# set -g @rose_pine_window_status_separator "  " # Changes the default icon that appears between window names

# Very beta and specific opt-in settings, tested on v3.2a, look at issue #10
# set -g @rose_pine_prioritize_windows 'on' # Disables the right side functionality in a certain window count / terminal width
set -g @rose_pine_width_to_hide '80' # Specify a terminal width to toggle off most of the right side functionality
# set -g @rose_pine_window_count '5' # Specify a number of windows, if there are more than the number, do the same as width_to_hide


# Add new sections
set -g @rose_pine_status_left_prepend_section '#{?client_prefix,#[bg=#31748f],#{?pane_in_mode,#[fg=#21202e bg=#f6c177],#[bg=default]}}'
# set -g @rose_pine_status_left_append_section 'It works'
set -g @rose_pine_status_right_prepend_section '#{weather} '
# set -g @rose_pine_status_right_append_section ''

setw -g window-status-current-format '#{?pane_synchronized,#[fg=#21202e bg=#eb6f92],}#I:#W'
setw -g window-status-format         '#{?pane_synchronized,#[fg=#21202e bg=#eb6f92],}#I:#W'

run-shell ~/.config/tmux/plugins/tmux-weather/tmux-weather.tmux

