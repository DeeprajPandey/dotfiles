# ==========================
# ===  General settings  ===
# ==========================

set -ga terminal-overrides ",screen-256color*:Tc"
set -g default-terminal "screen-256color"
set -g buffer-limit 20              # number of buffers
set -g history-limit 65536          # scrollback lines
set -g display-time 850             # display message for 0.85s
set -g display-panes-time 1250      # display pane ids `prefix-q` for 1.25s
set -sg escape-time 0
set -g repeat-time 300              # key repeat interval


# set prefix to C-A
unbind C-b
set -g prefix C-a

# C-a + C-a will send C-a through: helpful for nested tmux sessions as well
bind -r C-a send-prefix


# Set parent terminal title to reflect current window in tmux session
set -g set-titles on
set -g set-titles-string "#I:#W"

# Start index of window/pane with 1, match keyboard
set -g base-index 1
setw -g pane-base-index 1

# events & activity monitoring
set -g focus-events on
setw -g monitor-activity on
set -g visual-activity on

setw -g aggressive-resize on      # resize to client win dimensions (check win-size)
setw -g window-size latest        # resize to latest client win dimensions
set -g remain-on-exit off         # destroy pane on command exit (`respawn-pane`)
set -g renumber-windows on        # renumber windows after any win is destroyed
set -g detach-on-destroy off      # switch to last session on kill
set -g mouse on                   # enable mouse control (clickable + resizeable)



# ==========================
# ===   Key bindings     ===
# ==========================

## Session Keybindings
# prefix + :      -> new -s [name]
# prefix + $      -> rename current session
# prefix + s      -> show list of sessions
# prefix + (      -> switch to previous session
# prefix + )      -> switch to next session

## Courtesy of tmux continuum
# prefix + ctrl+s -> save current tmux environment
# prefix + ctrl+r -> restore last saved tmux environment

## Window Keybindings
# prefix + c      -> new window
# prefix + ,      -> rename current window
# prefix + w      -> show list of windows and sessions
# prefix + l      -> last window
# prefix + "'"    -> select-window by id
# prefix + n      -> next-window
# prefix + p      -> previous-window
# prefix + l      -> last-window
# prefix + M-n    -> next window with alert
# prefix + M-p    -> next window with alert
# prefix + %      -> split-window -h
# prefix + '"'    -> split-window
# prefix + &      -> kill-window

## Pane Keybindings
# prefix + }      -> swap-pane -D
# prefix + {      -> swap-pane -U


# `prefix-r`: reload tmux config
bind r source-file ~/.config/tmux/tmux.conf \; display-message "~/.config/tmux/tmux.conf reloaded!"

# create new windows in cwd
bind c new-window -c '#{pane_current_path}'

# Kill pane/window/session shortcuts
bind x kill-pane                        # use `C-d` instead
bind Q confirm kill-window
bind C-x confirm -p "kill other windows? (y/n)" "kill-window -a"
bind X confirm -p "Confirm 'kill-session #S'? (y/n)" kill-session

# toggle synchronize-panes
bind C-y setw synchronize-panes

# emacs keybindings for command, choice, paste buffer, and find prompts
# partial vi bindings is confusing
set -g status-keys emacs


## Window Selection (`prefix-C-` + vi keybindings)
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

# # switch to windows 1 through 4 using u,i,o,p
# unbind p
# bind u select-window -t 1
# bind i select-window -t 2
# bind o select-window -t 3
# bind p select-window -t 4


## Pane Selection (`C-` + vi keybindings)
# smart pane switching with awareness of Vim splits
# see: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"
bind -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'
tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'
if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l'"
if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l'"

# vi keybindings for pane switching in copy mode
bind -T copy-mode-vi 'C-h' select-pane -L
bind -T copy-mode-vi 'C-j' select-pane -D
bind -T copy-mode-vi 'C-k' select-pane -U
bind -T copy-mode-vi 'C-l' select-pane -R
bind -T copy-mode-vi "C-\\" select-pane -l


## Pane Resizing (`prefix-S-` + vi keybindings)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 5

# `S-arrow` keys for small increments (no prefix)
bind -n S-Left resize-pane -L 2
bind -n S-Down resize-pane -D 1
bind -n S-Up resize-pane -U 1
bind -n S-Right resize-pane -R 2


## Sensible Pane Splits
# see: https://github.com/tmux-plugins/tmux-pain-control
# horizontal & vertical splits with (no-shift) `\` and `-` w/ default keybindings intact
bind "\\" split-window -h -c "#{pane_current_path}"
bind "%" split-window -h -c "#{pane_current_path}"
bind "-" split-window -v -c "#{pane_current_path}"
bind '"' split-window -v -c "#{pane_current_path}"

# full window splits (with shift) `|` and `_`
bind "|" split-window -fh -c "#{pane_current_path}"
bind "_" split-window -fv -c "#{pane_current_path}"


## Copy Mode Navigation & Behaviour (vi keybindings)
setw -g mode-keys vi

bind -T copy-mode-vi "v" send-keys -X begin-selection
bind -T copy-mode-vi "V" send-keys -X rectangle-toggle
bind -T copy-mode-vi "y" send-keys -X copy-selection-and-cancel



# =============================
# ===   Advanced Settings   ===
# =============================

# enable and disable keyboard input for panes
bind < select-pane -d \; display-message "input disabled"
bind > select-pane -e \; display-message "input enabled"

# clear history
bind C-x clear-history \; display-message "history cleared"

# reenable automatic renaming for the current window
bind N setw automatic-rename on \; display-message "automatic rename enabled"

# C-a ! breaks current pane into separate window
# join a pane/window from the current session into the current window
bind @ command-prompt -p "create pane from window #:" "join-pane -hs ':%%'"

# create new session (prompt for name)
bind S command-prompt -p "New session:" "new-session -As '%%'"

# link window
bind L command-prompt -p "Link window from (session:window): " "link-window -s %% -a"

# prompt to rename window right after it's created
# set-hook -g after-new-window 'command-prompt -I "#{window_name}" "rename-window: '%%'"'

# easily swap a pane (targeted by pane number) with the current pane
# we don't need choose-tree in window mode
bind w display-panes\; command-prompt -p "swap with pane (optional, s:w.p) #:"  "swap-pane -t '%%'"

# # swap panes back and forth with 1st pane
# # when in main-(horizontal|vertical) layouts, the biggest/widest panel is always @1
# bind \\ if '[ #{pane_index} -eq 1 ]' \
#      'swap-pane -s "!"' \
#      'select-pane -t:.1 ; swap-pane -d -t 1 -s "!"'

# sort session list in reverse chronological order
# -s starts with sessions collapsed (doesn't show windows)
# -Z zooms the pane
# -O specifies the initial sort field: one of 'index', 'name', or 'time' (activity).
# https://unix.stackexchange.com/questions/608268/how-can-i-force-tmux-to-sort-my-sessions-alphabetically
bind s choose-tree -Zs -O time

# switch between the last 2 sessions (similar to `cd -`)
unbind Space
bind Space switch-client -l

# break out current pane into a new session
bind-key C-b send-keys 'tat && exit' 'C-m'

# fuzzy find a session to switch to from a modal - fuzzyfind'r
bind C-j display-popup -E "tmux list-sessions | sed -E 's/:.*$//' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse | xargs tmux switch-client -t"

# create/attach to a new session for fzf'd project repo
bind f run-shell "tmux new-window -n \"fuzzyfind\'ir\" $HOME/.dotfiles/scripts/tat -f"

# open project todo if it exists else open general todo: theprimeagen
bind T neww -c "#{pane_current_path}" "[[ -e TODO.md ]] && nvim TODO.md || nvim ~/wd/_wip/todo.md"

# Merge session with another (upstream) one - e.g. move all windows
# If you use adhoc 1-window sessions, and you want to preserve session upon exit
# but don't want to create a lot of small unnamed 1-window sessions around
# move all windows from current session to main named one (dev, work, etc)
bind C-u command-prompt -p "Session to merge with:" \
   "run-shell 'yes | head -n #{session_windows} | xargs -I {} -n 1 tmux movew -t %%'"

# Detach other clients from current session
bind D if -F '#{session_many_attached}' \
    'confirm-before -p "Detach other clients? (y/n)" "detach -a"' \
    'display "Session has only 1 client attached"'

# open btop in horizontal split pane
bind b split-window -h btop



# ==================================================
# === Window monitoring for activity and silence ===
# ==================================================
bind m setw monitor-activity \; display-message 'Monitor window activity [#{?monitor-activity,ON,OFF}]'
bind M if -F '#{monitor-silence}' \
    'setw monitor-silence 0 ; display-message "Monitor window silence [OFF]"' \
    'command-prompt -p "Monitor silence interval (s):" "setw monitor-silence %%"'



### Appearance and Behaviour

# set -g status-position top

# clock appearance
setw -g clock-mode-colour colour64 #green

# TODO: do not take hex values
# # pane number appearance
# set -g display-panes-active-colour #fb4934
# set -g display-panes-colour #83a598

### Status bar config
set -g status-interval 60
set -g status-style bg=#282828,fg=#83a598   # default for transparent
set -g pane-border-style fg=#282828
set -g pane-active-border-style fg=#7c6f64
set -g message-style bg=#fbf1c7,fg=#076678

setw -g window-status-style fg=#a89984
setw -g window-status-current-style fg=#fabd2f
setw -g window-status-activity-style fg=#fb4934
setw -g window-status-bell-style fg=#fb4939
setw -g window-status-separator '  '
# setw -g window-status-separator ' | '

# symbol for zoomed flag is `CJK RADICAL DOG`. zoom -> zoomies -> dog -> character
setw -g window-status-format '\
#{?pane_synchronized,#[fg=#282828 bold bg=#d65d0e],}\
#{?window_zoomed_flag,⺨#[bold],}\
#I:#W\
'
setw -g window-status-current-format '\
#{?pane_synchronized,#[fg=#282828 bold bg=#d65d0e],}\
#{?window_zoomed_flag,⺨,}\
#I:#W\
'

set -g status-left-length 30
set -g status-left '\
#{?pane_input_off,#[fg=#1d2021 bold bg=#cc241d],}\
#{?client_prefix,#[fg=#d65d0e],#[fg=#a89984]}[\
#{?pane_input_off,#[fg=#1d2021],#[fg=default]}#S:#I.#P\
#{?client_prefix,#[fg=#d65d0e],#[fg=#a89984]}]\
#[bg=default] \
'

set -g status-right-length 100
set -g status-right '\
#([ "$(tmux show-option -gqv prefix)" != "C-a" ] && echo "($(tmux show-option -gqv prefix)) ")\
#{?client_readonly,#[fg=#1d2021 bg=#fabd2f bold] ◢◤◢◤◢◤◢◤ Read Only ◢◤◢◤◢◤◢◤  #[default] ,}\
#{?client_prefix,#[fg=#d65d0e],#[fg=#a89984]} \
#[fg=#8ec07c]#(echo "#{pane_current_path}" | rev | cut -d"/" -f-3 | rev) \
#{?client_prefix,#[fg=#d65d0e],#[fg=#a89984]}  \
#[fg=#d3869b]#([ -f $HOME/.name ] && cat $HOME/.name || hostname) \
#{?client_prefix,#[fg=#d65d0e],#[fg=#a89984]} 󰒋 \
#[fg=#8ec07c]#{weather}\
'


### Plugins
# tmux-resurrect: persist tmux sessions across system restarts
# Note: no session is deleted automatically. Select a session manually by symlinking `last` to session.txt
# in `~/.local/share/tmux/resurrect`. Ref: https://github.com/tmux-plugins/tmux-resurrect/blob/master/docs/restoring_previously_saved_environment.md#restoring-previously-saved-environment
# prefix + ctrl + [s|r] for save/restore
run-shell ~/.config/tmux/plugins/tmux-resurrect/resurrect.tmux
# known issue with default-command (if it has && or ||)
# https://github.com/tmux-plugins/tmux-resurrect/blob/master/docs/restoring_pane_contents.md#known-issue
set -g @resurrect-capture-pane-contents 'on'

# tmux-continuum: automatically save tmux session, no need to manually save/restore
run-shell ~/.config/tmux/plugins/tmux-continuum/continuum.tmux

# tmux-weather: current weather in status bar
run-shell ~/.config/tmux/plugins/tmux-weather/tmux-weather.tmux


### Allow local customization in ~/.tmux_local.conf
if-shell "[ -f ~/.tmux_local.conf ]" 'source ~/.tmux_local.conf'

